{% extends 'base.html' %}
{% block title %}Extract Packet{% endblock %}
{% block header %}Extract from {{ filename }}{% endblock %}
{% block content %}
<form method="post" class="mb-3">
  <div class="row g-2 mb-2">
    <div class="col">
      <label class="form-label">Start sample:</label>
      <input type="number" id="startInput" name="start" value="{{ start }}" class="form-control">
      <input type="range" id="startSlider" min="0" max="{{ total - 1 }}" value="{{ start }}" class="form-range">
    </div>
    <div class="col">
      <label class="form-label">End sample:</label>
      <input type="number" id="endInput" name="end" value="{{ end }}" class="form-control">
      <input type="range" id="endSlider" min="1" max="{{ total }}" value="{{ end }}" class="form-range">
    </div>
  </div>
  <button type="submit" class="btn btn-primary">Save Packet</button>
</form>
<div id="plot" class="mb-3"></div>
<img class="img-fluid" src="{{ url_for('data_file', filename=image) }}" alt="Preview">
{% if saved %}
<p class="mt-3"><a href="{{ url_for('data_file', filename=saved) }}">Download {{ saved }}</a></p>
{% endif %}
<p><a href="{{ url_for('index') }}">Back to Home</a></p>
<script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min"></script>
<script>
  const signal = {{ preview_signal|tojson }};
  const step = {{ display_step }};
  const total = {{ total }};
  let layout = {
    margin: {t: 20, l: 40, r: 20, b: 40},
    shapes: [
      {type:'line', x0:{{ start }}, x1:{{ start }}, y0:0, y1:1, yref:'paper', line:{color:'green', dash:'dot'}},
      {type:'line', x0:{{ end }}, x1:{{ end }}, y0:0, y1:1, yref:'paper', line:{color:'red', dash:'dot'}}
    ]
  };
  Plotly.newPlot('plot', [{x:Array.from({length: signal.length}, (_,i)=>i*step), y:signal, mode:'lines'}], layout);
  function update(which,val){
    const index = which==='start'?0:1;
    const update={};
    update[`shapes[${index}].x0`]=val;
    update[`shapes[${index}].x1`]=val;
    Plotly.relayout('plot', update);
  }
  document.getElementById('startSlider').oninput=e=>{document.getElementById('startInput').value=e.target.value;update('start',e.target.value)};
  document.getElementById('endSlider').oninput=e=>{document.getElementById('endInput').value=e.target.value;update('end',e.target.value)};
</script>
{% endblock %}
